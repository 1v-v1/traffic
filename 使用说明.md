# 交通分配系统 (Traffic Assignment System)

电子科技大学 - 交通域划原理课程报告 2025

## 项目简介

本项目实现了完整的交通分配系统，支持三种主流交通分配算法：

1. **全有全无分配** (All-or-Nothing Assignment)
2. **增量分配** (Incremental Assignment)
3. **Frank-Wolfe用户均衡分配** (User Equilibrium with Frank-Wolfe)

系统基于BPR (Bureau of Public Roads) 行程时间函数，能够对路网进行流量分配、性能评估和可视化分析。

## 功能特性

### 核心功能
- ✅ 路网数据加载与管理
- ✅ OD需求处理
- ✅ 基于Dijkstra的最短路径计算
- ✅ 三种交通分配算法
- ✅ BPR行程时间模型
- ✅ 路网性能评估指标
- ✅ 完整的可视化系统

### 技术特点
- 模块化设计，符合SOLID原则
- 完整的日志系统
- 详细的错误处理
- 单元测试和集成测试

## 项目结构

```
traffic_assignment/
├── data/                       # 数据文件
│   ├── network.json           # 路网数据
│   └── demand.json            # 需求数据
├── src/                       # 源代码
│   ├── models/                # 数据模型
│   │   ├── link.py           # 路段类（BPR函数）
│   │   ├── network.py        # 路网类
│   │   └── demand.py         # 需求类
│   ├── algorithms/            # 算法实现
│   │   ├── dijkstra.py       # 最短路径
│   │   ├── all_or_nothing.py # 全有全无
│   │   ├── incremental.py    # 增量分配
│   │   └── frank_wolfe.py    # Frank-Wolfe
│   ├── evaluation/            # 评估指标
│   │   └── metrics.py
│   ├── visualization/         # 可视化
│   │   └── plotter.py
│   └── utils/                 # 工具函数
│       └── logger.py
├── tests/                     # 测试文件
│   ├── test_models.py
│   ├── test_algorithms.py
│   ├── test_evaluation.py
│   └── test_integration.py
├── output/                    # 输出目录
├── main.py                    # 主程序
├── requirements.txt           # 依赖管理
└── README.md
```

## 安装与使用

### 环境要求
- Python 3.8+
- pip

### 安装依赖

```bash
cd traffic_assignment
pip install -r requirements.txt
```

### 运行主程序

```bash
python main.py
```

程序将自动执行以下步骤：
1. 加载路网和需求数据
2. 执行三种分配算法
3. 计算性能指标
4. 生成可视化图表
5. 输出对比结果

所有结果保存在 `output/` 目录下。

### 运行测试

```bash
# 运行所有测试
pytest tests/ -v

# 运行特定测试
pytest tests/test_models.py -v
pytest tests/test_algorithms.py -v
pytest tests/test_integration.py -v
```

## 算法说明

### 1. 全有全无分配 (All-or-Nothing)

**原理**：基于当前路网状态，为每个OD对计算最短路径，将全部需求分配到最短路径上。

**特点**：
- 计算速度快
- 不考虑拥堵效应
- 适合初始分配

### 2. 增量分配 (Incremental)

**原理**：将总需求分成多份（如40%、30%、20%、10%），逐步分配，每次分配后更新路段行程时间。

**特点**：
- 部分考虑拥堵效应
- 计算效率较高
- 结果介于全有全无和用户均衡之间

### 3. Frank-Wolfe用户均衡 (User Equilibrium)

**原理**：迭代寻找用户均衡状态，使用Frank-Wolfe算法求解。

**迭代步骤**：
1. 全有全无分配得到辅助流量
2. 计算相对间隙判断收敛
3. 线搜索确定最优步长
4. 更新流量并重复

**特点**：
- 达到用户均衡（Wardrop第一原则）
- 收敛性保证
- 计算时间较长但结果最优

## BPR行程时间函数

```
t(q) = t₀ × (1 + q/cap)²
```

其中：
- `t(q)`: 实际行程时间
- `t₀`: 自由流行程时间 = 路段长度 / 最大速度
- `q`: 路段流量
- `cap`: 路段容量

## 数据格式

### network.json
```json
{
    "nodes": {
        "name": ["A", "B", "C", ...],
        "x": [0, 10, 20, ...],
        "y": [0, 0, 0, ...]
    },
    "links": {
        "between": ["AB", "BC", ...],
        "capacity": [1800, 3600, ...],
        "speedmax": [30, 60, ...]
    }
}
```

### demand.json
```json
{
    "from": ["A", "F", ...],
    "to": ["F", "A", ...],
    "amount": [2000, 1000, ...]
}
```

## 输出结果

程序会生成以下文件：

1. `01_network.png` - 路网结构图
2. `02_all_or_nothing.png` - 全有全无分配结果
3. `03_incremental.png` - 增量分配结果
4. `04_frank_wolfe.png` - Frank-Wolfe分配结果
5. `05_convergence.png` - Frank-Wolfe收敛曲线
6. `06_comparison.png` - 算法对比图

## 性能指标

系统计算以下指标：

- **总出行时间**: Σ(flow × travel_time)
- **相对间隙**: Frank-Wolfe收敛指标
- **流量/容量比**: 各路段拥堵程度
- **路段行程时间**: 基于BPR函数

## 可视化说明

### 路网结构图
- 节点：圆形，标注节点名称
- 边：箭头，标注容量和速度

### 流量分配图
- 边宽度：表示流量大小
- 边颜色：
  - 绿色：畅通 (ratio < 0.5)
  - 橙色：拥挤 (0.5 ≤ ratio < 0.8)
  - 红色：拥堵 (ratio ≥ 0.8)

### 收敛曲线
- 左图：相对间隙随迭代变化
- 右图：总出行时间随迭代变化

## 开发规范

### 代码风格
- 遵循PEP 8规范
- 函数单一职责，长度≤30行
- 见名知意的变量命名

### 日志级别
- `INFO`: 关键业务事件
- `DEBUG`: 详细流程追踪
- `WARNING`: 潜在问题
- `ERROR`: 系统错误

### 测试覆盖
- 核心算法单元测试覆盖率 ≥ 90%
- 整体项目测试覆盖率 ≥ 70%

## 作者

电子科技大学学生
课程：交通域划原理
时间：2025年

## 许可证

本项目仅用于课程学习，禁止商业使用。

---

# 交通分配系统 - 快速使用指南

## 一、环境准备

### 1. 安装Python
确保您的系统已安装 Python 3.8 或更高版本。

检查Python版本：
```bash
python --version
```

### 2. 安装依赖包

在项目根目录下运行：
```bash
pip install -r requirements.txt
```

需要安装的包：
- numpy (数值计算)
- matplotlib (绘图)
- networkx (图算法)
- pytest (测试框架)

---

## 二、运行程序

### 方法1：直接运行Python

```bash
cd traffic_assignment
python main.py
```

### 方法2：使用批处理文件 (Windows)

双击 `run.bat` 文件

---

## 三、查看结果

程序运行完成后，查看 `output/` 目录：

1. **01_network.png** - 路网结构图
   - 显示所有节点和连接
   - 标注容量(cap)和速度(spd)

2. **02_all_or_nothing.png** - 全有全无分配结果
   - 边的粗细表示流量大小
   - 颜色表示拥堵程度（绿/橙/红）

3. **03_incremental.png** - 增量分配结果
   - 4轮迭代的流量分配
   
4. **04_frank_wolfe.png** - Frank-Wolfe用户均衡结果
   - 收敛后的均衡流量分配

5. **05_convergence.png** - 收敛曲线
   - 左图：相对间隙变化
   - 右图：总出行时间变化

6. **06_comparison.png** - 三种算法对比
   - 柱状图比较总出行时间

---

## 四、运行测试

### 运行所有测试
```bash
cd traffic_assignment
pytest tests/ -v
```

### 运行特定测试
```bash
pytest tests/test_models.py -v          # 测试数据模型
pytest tests/test_algorithms.py -v     # 测试算法
pytest tests/test_integration.py -v    # 测试完整流程
```

---

## 五、理解输出

### 控制台输出示例

```
============================================================
交通分配系统 - Traffic Assignment System
============================================================

[步骤1] 加载数据...
  路网加载成功: Network(nodes=7, links=8)
  需求加载成功: Demand(od_pairs=6, total=6000.0)

[步骤2] 执行全有全无分配...
  全有全无分配完成:
    总出行时间: 12345.67
    执行时间: 0.123秒

[步骤3] 执行增量分配...
  增量分配完成:
    总出行时间: 11234.56
    执行时间: 0.456秒

[步骤4] 执行Frank-Wolfe用户均衡分配...
  Frank-Wolfe分配完成:
    总出行时间: 10987.65
    迭代次数: 15
    最终相对间隙: 0.000998
    执行时间: 1.234秒

[步骤5] 算法结果对比...
============================================================
算法对比结果:
------------------------------------------------------------
算法                  总出行时间        执行时间(秒)
------------------------------------------------------------
全有全无分配         12345.67        0.123
增量分配             11234.56        0.456
Frank-Wolfe         10987.65        1.234
============================================================

[步骤6] 路段性能分析...
路段详细信息:
--------------------------------------------------------------------------------
路段     流量        容量        流量比      行程时间      自由流时间
--------------------------------------------------------------------------------
AB       1500.0     1800        0.83       0.502         0.333
BC       2000.0     3600        0.56       0.243         0.167
...
```

### 结果解读

1. **总出行时间**：越小越好
   - Frank-Wolfe < 增量分配 < 全有全无

2. **流量比** (flow/capacity)：
   - < 0.5: 畅通（绿色）
   - 0.5-0.8: 拥挤（橙色）
   - ≥ 0.8: 拥堵（红色）

3. **相对间隙**：Frank-Wolfe收敛指标
   - < 0.001: 收敛良好
   - < 0.01: 可接受
   - ≥ 0.01: 需要更多迭代

---

## 六、自定义数据

### 修改路网数据 (data/network.json)

```json
{
    "nodes": {
        "name": ["A", "B", "C"],           // 节点名称
        "x": [0, 10, 20],                  // X坐标
        "y": [0, 0, 0]                     // Y坐标
    },
    "links": {
        "between": ["AB", "BC"],           // 连接（起点+终点）
        "capacity": [1800, 3600],          // 容量
        "speedmax": [30, 60]               // 最大速度
    }
}
```

### 修改需求数据 (data/demand.json)

```json
{
    "from": ["A", "B"],                    // 起点
    "to": ["C", "A"],                      // 终点
    "amount": [1000, 500]                  // 需求量
}
```

---

## 七、常见问题

### Q1: 找不到模块错误
**问题**: `ModuleNotFoundError: No module named 'xxx'`

**解决**: 安装依赖
```bash
pip install -r requirements.txt
```

### Q2: 中文显示乱码
**问题**: 图表中中文显示为方块

**解决**: 
- Windows: 已自动使用SimHei字体
- Mac/Linux: 修改 `src/visualization/plotter.py` 中的字体设置

### Q3: 路径不收敛
**问题**: Frank-Wolfe没有找到某些OD对的路径

**解决**: 
- 检查路网是否连通
- 确认所有OD对在路网中存在

### Q4: 程序运行慢
**问题**: Frank-Wolfe运行时间长

**解决**: 
- 减小max_iter (默认50)
- 增大epsilon (默认0.001)
- 在 `main.py` 中修改参数

---

## 八、算法参数调整

在 `main.py` 中可以调整算法参数：

### 增量分配
```python
incremental_assignment(network, demand, n_iterations=4)
# n_iterations: 迭代次数，建议2-8
```

### Frank-Wolfe
```python
frank_wolfe_assignment(
    network, 
    demand, 
    max_iter=50,      # 最大迭代次数，建议20-100
    epsilon=0.001     # 收敛阈值，建议0.0001-0.01
)
```

---

## 九、技术支持

如有问题，请查看：
1. `README.md` - 详细技术文档
2. `issues/交通分配系统.md` - 开发文档
3. 源代码注释

---

## 十、文件说明

```
traffic_assignment/
├── data/                   # 数据目录
│   ├── network.json       # 路网数据（可修改）
│   └── demand.json        # 需求数据（可修改）
├── src/                   # 源代码（不建议修改）
├── tests/                 # 测试代码
├── output/                # 输出目录（自动生成）
├── main.py                # 主程序（可调参数）
├── run.bat                # 快速运行（Windows）
├── requirements.txt       # 依赖列表
├── README.md              # 技术文档
└── 使用说明.md            # 本文件
```

---

祝使用愉快！🚗🚦

