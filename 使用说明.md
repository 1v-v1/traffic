# 交通分配系统 - 快速使用指南

## 一、环境准备

### 1. 安装Python
确保您的系统已安装 Python 3.8 或更高版本。

检查Python版本：
```bash
python --version
```

### 2. 安装依赖包

在项目根目录下运行：
```bash
pip install -r requirements.txt
```

需要安装的包：
- numpy (数值计算)
- matplotlib (绘图)
- networkx (图算法)
- pytest (测试框架)

---

## 二、运行程序

### 方法1：直接运行Python

```bash
cd traffic_assignment
python main.py
```

### 方法2：使用批处理文件 (Windows)

双击 `run.bat` 文件

---

## 三、查看结果

程序运行完成后，查看 `output/` 目录：

1. **01_network.png** - 路网结构图
   - 显示所有节点和连接
   - 标注容量(cap)和速度(spd)

2. **02_all_or_nothing.png** - 全有全无分配结果
   - 边的粗细表示流量大小
   - 颜色表示拥堵程度（绿/橙/红）

3. **03_incremental.png** - 增量分配结果
   - 4轮迭代的流量分配
   
4. **04_frank_wolfe.png** - Frank-Wolfe用户均衡结果
   - 收敛后的均衡流量分配

5. **05_convergence.png** - 收敛曲线
   - 左图：相对间隙变化
   - 右图：总出行时间变化

6. **06_comparison.png** - 三种算法对比
   - 柱状图比较总出行时间

---

## 四、运行测试

### 运行所有测试
```bash
cd traffic_assignment
pytest tests/ -v
```

### 运行特定测试
```bash
pytest tests/test_models.py -v          # 测试数据模型
pytest tests/test_algorithms.py -v     # 测试算法
pytest tests/test_integration.py -v    # 测试完整流程
```

---

## 五、理解输出

### 控制台输出示例

```
============================================================
交通分配系统 - Traffic Assignment System
============================================================

[步骤1] 加载数据...
  路网加载成功: Network(nodes=7, links=8)
  需求加载成功: Demand(od_pairs=6, total=6000.0)

[步骤2] 执行全有全无分配...
  全有全无分配完成:
    总出行时间: 12345.67
    执行时间: 0.123秒

[步骤3] 执行增量分配...
  增量分配完成:
    总出行时间: 11234.56
    执行时间: 0.456秒

[步骤4] 执行Frank-Wolfe用户均衡分配...
  Frank-Wolfe分配完成:
    总出行时间: 10987.65
    迭代次数: 15
    最终相对间隙: 0.000998
    执行时间: 1.234秒

[步骤5] 算法结果对比...
============================================================
算法对比结果:
------------------------------------------------------------
算法                  总出行时间        执行时间(秒)
------------------------------------------------------------
全有全无分配         12345.67        0.123
增量分配             11234.56        0.456
Frank-Wolfe         10987.65        1.234
============================================================

[步骤6] 路段性能分析...
路段详细信息:
--------------------------------------------------------------------------------
路段     流量        容量        流量比      行程时间      自由流时间
--------------------------------------------------------------------------------
AB       1500.0     1800        0.83       0.502         0.333
BC       2000.0     3600        0.56       0.243         0.167
...
```

### 结果解读

1. **总出行时间**：越小越好
   - Frank-Wolfe < 增量分配 < 全有全无

2. **流量比** (flow/capacity)：
   - < 0.5: 畅通（绿色）
   - 0.5-0.8: 拥挤（橙色）
   - ≥ 0.8: 拥堵（红色）

3. **相对间隙**：Frank-Wolfe收敛指标
   - < 0.001: 收敛良好
   - < 0.01: 可接受
   - ≥ 0.01: 需要更多迭代

---

## 六、自定义数据

### 修改路网数据 (data/network.json)

```json
{
    "nodes": {
        "name": ["A", "B", "C"],           // 节点名称
        "x": [0, 10, 20],                  // X坐标
        "y": [0, 0, 0]                     // Y坐标
    },
    "links": {
        "between": ["AB", "BC"],           // 连接（起点+终点）
        "capacity": [1800, 3600],          // 容量
        "speedmax": [30, 60]               // 最大速度
    }
}
```

### 修改需求数据 (data/demand.json)

```json
{
    "from": ["A", "B"],                    // 起点
    "to": ["C", "A"],                      // 终点
    "amount": [1000, 500]                  // 需求量
}
```

---

## 七、常见问题

### Q1: 找不到模块错误
**问题**: `ModuleNotFoundError: No module named 'xxx'`

**解决**: 安装依赖
```bash
pip install -r requirements.txt
```

### Q2: 中文显示乱码
**问题**: 图表中中文显示为方块

**解决**: 
- Windows: 已自动使用SimHei字体
- Mac/Linux: 修改 `src/visualization/plotter.py` 中的字体设置

### Q3: 路径不收敛
**问题**: Frank-Wolfe没有找到某些OD对的路径

**解决**: 
- 检查路网是否连通
- 确认所有OD对在路网中存在

### Q4: 程序运行慢
**问题**: Frank-Wolfe运行时间长

**解决**: 
- 减小max_iter (默认50)
- 增大epsilon (默认0.001)
- 在 `main.py` 中修改参数

---

## 八、算法参数调整

在 `main.py` 中可以调整算法参数：

### 增量分配
```python
incremental_assignment(network, demand, n_iterations=4)
# n_iterations: 迭代次数，建议2-8
```

### Frank-Wolfe
```python
frank_wolfe_assignment(
    network, 
    demand, 
    max_iter=50,      # 最大迭代次数，建议20-100
    epsilon=0.001     # 收敛阈值，建议0.0001-0.01
)
```

---

## 九、技术支持

如有问题，请查看：
1. `README.md` - 详细技术文档
2. `issues/交通分配系统.md` - 开发文档
3. 源代码注释

---

## 十、文件说明

```
traffic_assignment/
├── data/                   # 数据目录
│   ├── network.json       # 路网数据（可修改）
│   └── demand.json        # 需求数据（可修改）
├── src/                   # 源代码（不建议修改）
├── tests/                 # 测试代码
├── output/                # 输出目录（自动生成）
├── main.py                # 主程序（可调参数）
├── run.bat                # 快速运行（Windows）
├── requirements.txt       # 依赖列表
├── README.md              # 技术文档
└── 使用说明.md            # 本文件
```

---

祝使用愉快！🚗🚦

